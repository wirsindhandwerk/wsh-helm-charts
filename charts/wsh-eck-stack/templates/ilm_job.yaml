apiVersion: batch/v1
kind: Job
metadata:
  name: imlpolicy
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  template:
    metadata:
      name: imlpolicy
    spec:
      restartPolicy: Never
      containers:
      - name: post-install-job
        image: "curlimages/curl:7.76.0"
        args:
        - /bin/sh
        - -c
        - "sleep 30 ; curl -X PUT -u 'example-user:$2y$10$OrZF7nYE37TBmblHsKRTz.vsrzuI3PwpIzn94F5Hhl/gfW.CblhcG' -k 'https://elasticsearch-es-http.{{ .Release.Namespace }}.svc.cluster.local:9200/_ilm/policy/ilm_custom_policy' -H 'Content-Type: application/json' -d'{\"policy\":{\"phases\":{\"hot\":{\"actions\":{\"rollover\":{\"max_size\":\"{{ .Values.indexLifecycle.rollover }}\",\"max_age\":\"{{ .Values.indexLifecycle.deleteAfterDays }}\"}}},\"delete\":{\"min_age\":\"14d\",\"actions\":{\"delete\":{}}}}}}'; exit 0"
